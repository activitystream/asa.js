!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("promise-polyfill/src/polyfill"),require("whatwg-url"),require("whatwg-fetch")):"function"==typeof define&&define.amd?define(["promise-polyfill/src/polyfill","whatwg-url","whatwg-fetch"],t):t((e=e||self).Promise,e.whatwgUrl)}(this,function(e,n){"use strict";var t=function(){var n={};return{setItem:function(e,t){n[e]=t},getItem:function(e){return n[e]},removeItem:function(e){delete n[e]},clear:function(){n={}},key:function(e){return n[Object.keys(n)[e]]},get length(){return Object.keys(n).length}}};if(String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>n.length)&&(t=n.length),t-=e.length;var r=n.indexOf(e,t);return-1!==r&&r===t}),window.localStorage)try{localStorage.localStorage=1,delete localStorage.localStorage}catch(e){var r=t(),o=t();Object.defineProperties(window,{localStorage:{get:function(){return r}},sessionStorage:{get:function(){return o}}})}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){y(t,e,n[e])})}return t}function c(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}window.URL||Object.defineProperties(window,{URL:{get:function(){return function(e){var t=document.createElement("a");return t.href=e,t.searchParams=new n.URLSearchParams(t.search),t}}}});var u={utm_campaign:["utm_campaign"],utm_medium:["utm_medium"],utm_source:["utm_source"],utm_content:["utm_content"],utm_term:["utm_term"]},f=function(e){var r=e.referrer,o=e.location,i=e.storage,a={};return l(function(e,t){var n=t.map(function(e){return r&&r.searchParams.get(e)||o.searchParams.get(e)||i.getItem("__as.".concat(e))}).find(Boolean);n&&(a[e.substr(4)]=n)}),a},l=function(t){return Object.keys(u).map(function(e){return t(e,u[e])})},_={PARTNER_ID_KEY:"__as.partner_id",PARTNER_SID_KEY:"__as.partner_sid"},m=function(e){var t,r,o,n,i,a=e.referrer&&e.referrer.host,s=e.location.host;a&&a!==s&&(r=(t=e).location,o=t.storage,n=r.searchParams.get(_.PARTNER_ID_KEY)||"",i=r.searchParams.get(_.PARTNER_SID_KEY)||"",l(function(e,t){var n=t.map(function(e){return decodeURIComponent(r.searchParams.get(e)||"")}).find(Boolean)||"";n?o.setItem("__as.".concat(e),n):o.removeItem("__as.".concat(e))}),n?o.setItem(_.PARTNER_ID_KEY,n):o.removeItem(_.PARTNER_ID_KEY),i?o.setItem(_.PARTNER_SID_KEY,i):o.removeItem(_.PARTNER_SID_KEY))},h=new(function(){function t(){i(this,t),this._logger=t.none}return s(t,[{key:"mode",value:function(e){this._logger=e?t.console:t.none}},{key:"log",value:function(){this._logger.apply(this,arguments)}},{key:"force",value:function(){t.console.apply(t,arguments)}}],[{key:"none",value:function(){}},{key:"console",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];(function(){try{var e;(e=console).log.apply(e,arguments)}catch(e){}}).apply(void 0,["js"].concat(t))}}]),t}()),d=function(){return Math.round(Math.random()*Date.now())},g=0;function p(e){return function(e){for(var t,n=g?"0123456789ABCDEF":"0123456789abcdef",r="",o=0;o<e.length;o++)t=e.charCodeAt(o),r+=n.charAt(t>>>4&15)+n.charAt(15&t);return r}(function(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>24-n%32&255);return t}(function(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var n=Array(80),r=1732584193,o=-271733879,i=-1732584194,a=271733878,s=-1009589776,c=0;c<e.length;c+=16){for(var u=r,f=o,l=i,m=a,h=s,d=0;d<80;d++){n[d]=d<16?e[c+d]:E(n[d-3]^n[d-8]^n[d-14]^n[d-16],1);var g=w(w(E(r,5),v(d,o,i,a)),w(w(s,n[d]),(p=d)<20?1518500249:p<40?1859775393:p<60?-1894007588:-899497514));s=a,a=i,i=E(o,30),o=r,r=g}r=w(r,u),o=w(o,f),i=w(i,l),a=w(a,m),s=w(s,h)}var p;return Array(r,o,i,a,s)}(function(e){for(var t=Array(e.length>>2),n=0;n<t.length;n++)t[n]=0;for(var r=0;r<8*e.length;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<24-r%32;return t}(t=function(e){var t,n,r="",o=-1;for(;++o<e.length;)t=e.charCodeAt(o),n=o+1<e.length?e.charCodeAt(o+1):0,55296<=t&&t<=56319&&56320<=n&&n<=57343&&(t=65536+((1023&t)<<10)+(1023&n),o++),t<=127?r+=String.fromCharCode(t):t<=2047?r+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?r+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(r+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return r}(e)),8*t.length)));var t}function v(e,t,n,r){return e<20?t&n|~t&r:e<40?t^n^r:e<60?t&n|t&r|n&r:t^n^r}function w(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function E(e,t){return e<<t|e>>>32-t}var S="__asa_session",I=function(e,t){return e},A=function(n){I=function(t,e){try{return n(t,e)}catch(e){return t}}},P=function(e){return e&&"href"in e},R=function(e){return e&&"form"in e};var O,D="2.0.0",k=function(e,t){var n,r=e.location,o=e.title,i=e.storage,a=e.user,s=e.session.getSession(),c=s.id,u=s.referrer,f=s.campaign,l=s.tenant,m=(n=document.querySelector('head > meta[name="keywords"]'),I(Array.prototype.reduce.call(document.querySelectorAll('head > meta[property^="og:"]'),function(e,t){return b({},e,y({},t.getAttribute("property"),t.getAttribute("content")))},{keywords:n&&n.getAttribute("content")}))),h=i.getItem(_.PARTNER_ID_KEY)||"",d=i.getItem(_.PARTNER_SID_KEY)||"",g=r.origin,p=new Date,v={url:r.href,referrer:u?u.hostname:void 0};return{type:t,partner_id:h,partner_sid:d,origin:g,occurred:p,campaign:f,title:o,user:{did:a.getUser(),sid:c},page:v,meta:m,tenant:l,v:D}};(O||(O={})).Email="Email";var T={"as.web.session.started":function(e){return k(e,"as.web.session.started")},"as.web.session.resumed":function(e){return k(e,"as.web.session.resumed")},"as.web.product.viewed":function(e,t){var n=k(e,"as.web.product.viewed");return n.products=t.map(function(e){return"string"==typeof e?e:e.type?e.type+"/"+e.id:e.id}),n},"as.web.payment.completed":function(e,t){var n=k(e,"as.web.payment.completed");return n.orders=t.map(function(e){return"string"==typeof e?e:e.type?e.type+"/"+e.id:e.id}),n}},C=function(e,t){return("0"+Math.abs(t)).slice(-e)},N=function(e,t){return fetch(e,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"text/plain; charset=UTF-8"}})},j=function(e){return t={tid:"web.asa",ev:e,t:(n=new Date,r=-n.getTimezoneOffset(),o=new Date(n),o.setMinutes(n.getMinutes()+r),o.toISOString().slice(0,-1)+(~Math.sign(r)?"+":"-")+C(2,r/60)+":"+C(2,r%60))},N("//inbox2.activitystream.com/asa",t);var t,n,r,o},U=function(e,t){return N("//inbox2.activitystream.com/asa/error",{err:e,context:t,v:D})},x=new(function(){function e(){var n=this;i(this,e),this._dispatchEvent=j,this._dispatchError=U,this.pendingSubmission=[],this.done=!0,this.submitEvent=function(e){return n._dispatchEvent(e)},this.submitError=function(e,t){return n._dispatchError(e,t)}}return s(e,[{key:"batchEvent",value:function(e){this.pendingSubmission.push(e)}},{key:"batchOn",value:function(){var n=this;this.batchIntervalHandler=setInterval(function(){try{if(0<n.pendingSubmission.length&&n.done){var e=Math.min(n.pendingSubmission.length,10),t=n.pendingSubmission.slice(0,e);n.done=!1,t.forEach(function(e){return j(e).then(function(){return n.pendingSubmission.splice(0,t.length)}).catch(h.log)})}}catch(e){h.log("exception submitting",e)}},400)}},{key:"batchOff",value:function(){this.batchIntervalHandler?clearInterval(this.batchIntervalHandler):h.log("cannot batch off, it is not on")}},{key:"override",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this._dispatchEvent,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this._dispatchError;this._dispatchError=t,this._dispatchEvent=e}},{key:"reset",value:function(){this._dispatchError=U,this._dispatchEvent=j}}]),e}()),K="__as_user",Y=function(e,t){return"".concat(p(e),".").concat(p(t))};function L(n){var r="",t=[],o=function(e){return-1<t.indexOf(e)},i=function(e){var t=e.storage,n=e.location,r=!1;return{getUser:i,setUser:o,clearUser:function(){t.removeItem(K)},getHash:function(){return i().split(".")[1]},isUserNew:function(){return r}};function o(e){return e||(e=Y(n.host,d())),t.setItem(K,e),r=!0,e}function i(){var e=t.getItem(K);return(!e||70<e.length||e.length<40)&&(e=o()),e}}(n),c=function(n){var o=n.storage,r=n.user,i=n.location;return{hasSession:function(){try{return!!(a().t>Date.now())}catch(e){return!1}},getSession:a,createSession:function(e){var t=f(n);o.setItem(S,JSON.stringify(b({},e,t&&{campaign:t},{id:"".concat(p(i.host),".").concat(p("".concat(r.getUser(),".").concat(d()))),t:Date.now()+18e5})))},destroySession:function(){o.removeItem(S)},refreshSession:function(e){var t=f(e),n=a(),r=b({},n,t&&{campaign:t},e,{data:b({},n.data||{},e.data||{}),t:Date.now()+18e5});o.setItem(S,JSON.stringify(r))}};function a(){var t;try{t=JSON.parse(o.getItem(S))}catch(e){t={id:"",tenant:"",t:0}}return t.referrer=t.referrer&&new URL(t.referrer.toString()),t}}(b({},n,{user:i,tenant:"",isPartner:!!n.referrer&&o(n.referrer.hostname)})),a=b({},n,{user:i,session:c}),e=function(e){r=e,c.hasSession()?(c.refreshSession(b({},n,{tenant:r,user:i,isPartner:!!n.referrer&&o(n.referrer.hostname)})),x.submitEvent(k(a,"as.web.session.resumed")),h.log("session resumed")):(h.log("no session, starting a new one"),c.createSession(b({},n,{tenant:r,user:i,isPartner:!!n.referrer&&o(n.referrer.hostname)})),x.submitEvent(k(a,"as.web.session.started")))},s={"create.custom.session":function(e){c=e,a.session=c},"set.tenant.id":e,"tenant.id.provided":e,"set.connected.partners":function(e){return i=(t={session:c,tenant:r||"",domains:e}).session,a=t.tenant,s=t.domains,n=function(e){var t=e.target;if(t)if(P(t)){var n=new URL(t.href);if(~s.indexOf(n.host)){n.searchParams.set(_.PARTNER_ID_KEY,a),n.searchParams.set(_.PARTNER_SID_KEY,i.getSession().id);var r=i.getSession().campaign||{};l(function(e){var t=r[e.substr(4)];t&&n.searchParams.set(e,t)}),t.href=n.href}}else if(R(t)){var o=["input","input"].map(document.createElement);o[0].name=_.PARTNER_ID_KEY,o[0].value=a,o[1].name=_.PARTNER_SID_KEY,o[1].value=i.getSession().id,o.forEach(function(e){e.type="hidden",t.form&&t.form.appendChild(e)})}},document.addEventListener("mousedown",n),document.addEventListener("keyup",n),void document.addEventListener("touchstart",n);var t,i,a,s,n},"set.service.providers":function(e){return t=e},"set.partner.key":function(e,t){_[e]=t,m(a)},"set.logger.mode":h.mode,"set.metadata.transformer":A,"set.utm.aliases":function(e){var t;t=e,Object.keys(t).forEach(function(e){u[e]=u[e].concat(t[e])}),c.refreshSession(b({},n,{tenant:r,user:i,isPartner:!!n.referrer&&o(n.referrer.hostname)}))}};return function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];try{if(!(e in T))return void(e in s&&s[e].apply(s,n));x.submitEvent(T[e].apply(T,[a].concat(n)))}catch(e){h.force("inbox exception:",e),x.submitError(e,{location:"processing inbox message",arguments:[event].concat(n)})}}}!function(){try{var e=window.asa&&window.asa.q||[],t={location:new URL(document.location.toString()),referrer:document.referrer?new URL(document.referrer):void 0,storage:sessionStorage,title:document.title};window.asa=L(t),m(t),e.forEach(function(e){var t;return(t=window).asa.apply(t,c(e))})}catch(e){h.force("exception during init: ",e),x.submitError(e,{location:"boot script"})}}()});
